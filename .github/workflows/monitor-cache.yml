name: Monitor Cache Status

on:
  schedule:
    - cron: '0 12 * * *'  # Daily at noon
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./game-grid
    steps:
    - name: Check cache status
      uses: actions/github-script@v7
      with:
        script: |
          const caches = await github.rest.actions.getActionsCaches({
            owner: context.repo.owner,
            repo: context.repo.repo,
          });
          
          const gameGridCaches = caches.data.actions_caches
            .filter(cache => cache.key.includes('game-grid-cache'))
            .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
          
          console.log(`Total caches: ${caches.data.total_count}`);
          console.log(`Game Grid caches: ${gameGridCaches.length}`);
          
          if (gameGridCaches.length > 0) {
            const latest = gameGridCaches[0];
            console.log(`Latest cache: ${latest.key}`);
            console.log(`Cache size: ${(latest.size_in_bytes / 1024 / 1024).toFixed(2)} MB`);
            console.log(`Created: ${latest.created_at}`);
            console.log(`Last accessed: ${latest.last_accessed_at}`);
          }
          
          // Alert if cache is getting too large (>500MB)
          if (gameGridCaches.length > 0 && gameGridCaches[0].size_in_bytes > 500 * 1024 * 1024) {
            console.log('⚠️ WARNING: Cache size is getting large!');
          }
          
          // Alert if we have too many caches
          if (gameGridCaches.length > 10) {
            console.log('⚠️ WARNING: Too many caches stored!');
          }
